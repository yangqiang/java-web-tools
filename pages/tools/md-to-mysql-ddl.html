<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>md2mysql</title>
    <style>
        #input, #output {
            width: 500px;
            height: 250px;
        }
    </style>
</head>
<body>
<h2>markdown to mysql ddl</h2>
convert markdown to mysql ddl<br>
<textarea id="input">
### 人群去重任务 crowd_remove_duplicate_task
|字段| 字段类型|含义|是否必须(默认是)|
|-|-|-|-|
| id         | varchar(36) |                                |                    |
| createTime | datetime    | 创建时间                       |                    |
| updateTime | datetime    | 更新时间                       |                    |
| status | tinyint unsigned|状态|
| calculations | json | 关联的交并差计算列表
|result|json|计算结果|否
|failure_reason|varchar(100)|失败原因|否
</textarea>
<input id="id-btn" type="button" value="convert">
<textarea id="output"></textarea>
<div>
    <a id="id-error" style="color:red"></a>
</div>
</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="util.js"></script>
<script>
    function isTableName(line) {
        return line.startsWith('##');
    }

    function getTableInfo(line) {
        var ret = {};
        line = line.replace(/^#+/, '');
        line = removePrefixAndPostfixSpace(line);
        var words = line.split(' ');
        ret.name = words[1];
        ret.description = words[0];
        return ret;
    }

    function isTableSep(line) {
        return /-+\s*\|\s*-+/.test(line);
    }

    function isField(line) {
        line = removePrefixAndPostfixSep(removePrefixAndPostfixSpace(line));
        words = line.split('|');
        return words.length > 1;
    }

    function getField(line) {
        line = removePrefixAndPostfixSep(removePrefixAndPostfixSpace(line));

        words = line.split('|');
        if (words.length < 2) {
            console.log('error parse field: ' + line);
        } else {
            var ret = {};
            ret.name = removePrefixAndPostfixSpace(words[0]);
            ret.type = removePrefixAndPostfixSpace(words[1]);
            ret.description = removePrefixAndPostfixSpace(words[2]);
            ret.null = words[3] !== undefined && words[3].indexOf('否') !== -1;
            return ret;
        }
        return undefined;
    }

    function parse(lines) {
        var lineList = lines.split('\n');
        var table;
        var fields;
        var ret = "";
        var status = {};
        status.meetTable = false;
        status.meetSep = false;
        status.meetField = false;

        for (var i in lineList) {
            var line = lineList[i];
            if (!status.meetTable) {
                if (!isTableName(line)) {
                    continue;
                } else {
                    table = getTableInfo(line);
                    status.meetTable = true;
                    fields = [];
                }
            } else {
                if (!status.meetSep) {
                    if (!isTableSep(line)) {
                        continue;
                    } else {
                        status.meetSep = true;
                    }
                } else {
                    if (isField(line)) {
                        fields.push(getField(line));
                    } else {
                        status.meetTable = false;
                        status.meetSep = false;
                        status.meetField = false;
                        ret += render(table, fields) + "\n";
                        fields = [];

                        if (isTableName(line)) {
                            table = getTableInfo(line);
                            status.meetTable = true;
                            fields = [];
                        }
                    }
                }
            }
        }
        if (fields.length > 0) {
            ret += render(table, fields) + "\n";
        }
        return ret;
    }

    function render(table, fields) {
        var s = "create table " + toSnake(table.name) + "\n(\n";
        for (var i in fields) {
            var f = fields[i];
            s += toSnake(f.name) + " " + f.type;
            if (!f.null) {
                s += " not null"
            }
            if (f.description) {
                s += " comment '" + f.description + "'";
            }
            if (i != fields.length - 1) {
                s += ','
            }
            s += '\n';
        }
        s += ")";
        if (table.description !== undefined) {
            s += "\ncomment '" + table.description + "';"
        }
        return s + '\n';
    }

    function error(msg) {
        $('#id-error').text(msg);
    }

    $('#id-btn').click(function (event) {
        error("");
        $('#output').val('');

        var input = $('#input').val();
        try {
            $('#output').val(parse(input));
        } catch (e) {
            error(e.message);
        }
    });
</script>
</html>